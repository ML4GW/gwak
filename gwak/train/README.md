# Training `GWAK`

This repository contains a `Snakefile` that pipelines the training of contrastive learning (CL) models and flow models (FM), and produces evaluation plots using trained models. The workflow is defined using [Snakemake](https://snakemake.readthedocs.io/).

## Overview

The workflow consists of three main steps:

1. **`train_cl`** â€“ Train a contrastive learning model.
2. **`train_fm`** â€“ Train a flow model on embeddings generated by a CL model.
3. **`make_plots`** â€“ Generate evaluation plots using trained CL and FM models.

## Configuration

The pipeline supports multiple training configurations, which are specified as YAML files in the `train/configs/` directory.

### Supported CL Configurations

- `Transformer_SimCLR_multiSignal_all`
- `Transformer_SimCLR_multiSignalAndBkg_noSG`
- `S4_SimCLR_multiSignalAndBkg`

### Supported FM Configurations

- `NF_onlyBkg`
- `FM_multiSignalAndBkg`

## ðŸ”— Rule Dependencies

The workflow is structured into three dependent stages, where each stage builds upon the outputs of the previous one:

---

### âž¤ Step 1: `train_cl`

Trains a contrastive learning (CL) model based on a given configuration.

- **Input:** `train/configs/{cl_config}.yaml`
- **Output:** `output/{cl_config}/model.pt`
- âœ… **Must complete before:** `train_fm`

---

### âž¤ Step 2: `precompute_embeddings`

Precomputes embeddings and normalization statistics from the trained classifier (CL) model to be used as input for the flow model (FM).

- **Input:**
  - CL model: `output/{cl_config}/model.pt`
  - Background data: `output/O4_MDC_background/{ifos}/`
  - Config: `train/configs/{cl_config}.yaml`
- **Output:**
  - Embeddings: `output/{cl_config}_{ifos}/embeddings.npy`
  - Labels: `output/{cl_config}_{ifos}/labels.npy`
  - Correlations: `output/{cl_config}_{ifos}/correlations.npy`
  - Normalization: `means.npy`, `stds.npy`
- âœ… **Depends on:** `train_cl`
- âœ… **Must complete before:** `train_fm`, `make_plots`

---

### âž¤ Step 3: `train_fm`

Trains a flow model (FM) using embeddings generated from a trained classifier (CL) model.

- **Input:**
  - Embeddings: `output/{cl_config}_{ifos}/embeddings.npy`
  - Correlations: `output/{cl_config}_{ifos}/correlations.npy`
  - Normalization: `means.npy`, `stds.npy`
  - Config: `train/configs/{fm_config}.yaml`
- **Output:** `output/{cl_config}_{fm_config}_{ifos}/model_JIT.pt`
- âœ… **Depends on:** `precompute_embeddings`
- âœ… **Must complete before:** `make_plots`

---

### âž¤ Step 4: `make_plots`

Generates evaluation plots using both the classifier (CL) and flow model (FM), along with the embedding data.

- **Input:**
  - CL model: `output/{cl_config}/model.pt`
  - FM model: `output/{cl_config}_{fm_config}_{ifos}/model_JIT.pt`
  - Background data: `output/O4_MDC_background/{ifos}/`
  - Config: `train/configs/{cl_config}.yaml`
- **Output:** `output/plots/{cl_config}_{fm_config}_{ifos}/`
- âœ… **Depends on:** `precompute_embeddings`, `train_fm`, `train_cl`

---